<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Яндекс.Карты</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://api-maps.yandex.ru/2.1/?apikey=52c2e7b2-2008-4f6a-b445-d50dd722b668&lang=ru_RU" type="text/javascript"></script>
  <style>
    :root{--bg:#f7f9fc;--panel:#fff;--accent:#0077cc;--accent2:#ff5722}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    .layout{display:grid;grid-template-columns:660px 1fr;gap:12px;height:100vh;padding:12px;box-sizing:border-box}
    .panel{background:var(--panel);border-radius:8px;padding:4px;box-shadow:0 1px 6px rgba(10,20,30,.06);display:flex;flex-direction:column;gap:8px}
    h3{margin:0 0 6px 0;font-size:15px}
    #map{border-radius:8px;overflow:hidden;height:100%}
    .coord-row{font-size:13px;color:#333;background:#f5f8fb;padding:8px;border-radius:6px}
    .coord-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
    .coord-item{display:flex;justify-content:space-between;gap:6px;padding:8px;border-radius:6px;background:#fff;align-items:center;border:1px solid #eef3f8}
    .coord-text{font-size:13px;color:#222}
    .small-btn{background:transparent;border:1px solid #e0e6ee;color:var(--accent);padding:6px 8px;border-radius:6px;cursor:pointer;font-size:13px}
    .small-btn.danger{color:#c62828;border-color:#f8d7da}
    .actions{display:flex;gap:6px}
    .form-row{display:flex;gap:6px}
    input[type="text"]{padding:8px;border-radius:6px;border:1px solid #dfe9f5;flex:1}
    button.primary{background:var(--accent);color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #d0d9e6;padding:8px 10px;border-radius:6px;cursor:pointer}
    .routes-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto}
    .route-item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      padding:8px;
      border-radius:6px;
      background:#fff;
      border:1px solid #eef3f8;
      cursor:default;
    }
    .route-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
      flex:1 1 auto;
    }
    .route-name-row{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .route-name{
      font-weight:600;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .route-toggle {
      background:transparent;
      border:none;
      padding:6px;
      cursor:pointer;
      color:var(--accent);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:6px;
    }
    .route-toggle:hover{ background:rgba(0,0,0,0.03); }
    .route-item-desc{
      overflow:hidden;
      max-height:0;
      transition: max-height 260ms ease;
      font-size:13px;
      color:#222;
      background:transparent;
      padding:0 0;
      border-radius:6px;
      white-space:pre-wrap;
    }
    .route-item-desc.open{
      max-height: 300px;
      padding-top:6px;
    }
    .route-actions{
      display:flex;
      gap:6px;
      flex:0 0 240px;
      align-items:center;
      justify-content:flex-end;
    }
    .meta{font-size:12px;color:#666}
    .name-input{border:1px solid #dfe9f5;padding:6px;border-radius:6px;width:100%}
    .footer-row{display:flex;gap:8px;justify-content:space-between;align-items:center}
    .muted{font-size:12px;color:#666}
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35)}
    .modal-card{background:#fff;padding:16px;border-radius:8px;width:420px;box-shadow:0 6px 30px rgba(10,20,30,0.2)}
    .point-thumb{max-width:120px;display:block;margin-top:6px;border-radius:6px}
    .route-desc { font-size:13px; color:#222; background:#fff; padding:8px; border-radius:6px; border:1px solid #eef3f8; margin-bottom:8px; white-space:pre-wrap; }
    @media (max-width:900px){
      .layout{grid-template-columns:1fr;grid-auto-rows:auto;height:auto}
      #map{height:60vh}
      .route-actions{flex:0 0 160px}
    }
    .editing-badge {
      display:inline-block;
      background:#fff4cc;
      color:#6b4f00;
      border:1px solid #ffe2a8;
      padding:6px 10px;
      border-radius:6px;
      font-size:13px;
      margin-left:8px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="panel" id="left-panel">
      <h3>Список точек <span id="editing-indicator" style="" class="editing-badge">Редактирование</span></h3>
      <div class="coord-row" id="coords-display">Курсор вне карты</div>

      <div id="route-description-container" style="display:none;margin-top:8px">
        <div id="route-description" class="route-desc"></div>
        <div style="display:flex;gap:8px;margin-bottom:6px">
          <button id="hide-route-desc" class="small-btn">Показать полностью</button>
        </div>
      </div>

      <ul class="coord-list" id="coord-list"></ul>

      <div class="footer-row" style="margin-top:8px">
        <div style="display:flex;gap:8px">
          <button id="clear-btn" class="small-btn">Очистить список</button>
          <button id="save-route-btn" class="primary">Сохранить маршрут</button>
          <button id="cancel-edit-btn" class="ghost" style="display:none">Отменить редактирование</button>
        </div>
        <div class="muted" id="points-count">0 точек</div>
      </div>

      <hr style="margin:10px 0"/>

      <h3>Добавить точку</h3>
      <div class="form-row">
        <input id="lat-input" type="text" placeholder="Широта" />
        <input id="lon-input" type="text" placeholder="Долгота" />
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="add-by-input" class="primary">Добавить точку</button>
        <button id="clear-all-btn" class="ghost">Очистить всё</button>
      </div>

      <hr style="margin:10px 0"/>

      <h3>Маршруты</h3>
      <ul class="routes-list" id="routes-list"></ul>
    </div>

    <div id="map"></div>
  </div>

  <div id="save-modal" class="modal" style="display:none">
    <div class="modal-card">
      <h4 style="margin-top:0" id="modal-title">Сохранить маршрут</h4>
      <div style="margin-bottom:8px">Точек в маршруте: <span id="modal-points-count">0</span></div>

      <label style="font-size:13px;margin-bottom:6px;display:block">Название</label>
      <input id="route-name-input" class="name-input" placeholder="Название маршрута" />

      <label style="font-size:13px;margin:10px 0 6px 0;display:block">Описание</label>
      <textarea id="route-desc-input" rows="4" style="width:100%;padding:8px;border-radius:6px;border:1px solid #dfe9f5;resize:vertical"></textarea>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="modal-cancel" class="ghost">Отмена</button>
        <button id="modal-save" class="primary">Сохранить</button>
      </div>
    </div>
  </div>

  <script> const URL_POINT_UPLOAD_BASE = "/points/"; </script>

  <script>
  ymaps.ready(init);
  function init() {
      window.myMap = new ymaps.Map('map', {
        center: [55.75, 37.57],
        zoom: 10,
        controls: []
      });
      try { myMap.controls.add('rulerControl'); } catch (e) {}

      var coordsDisplay = document.getElementById('coords-display');
      var coordList = document.getElementById('coord-list');
      var clearBtn = document.getElementById('clear-btn');
      var saveRouteBtn = document.getElementById('save-route-btn');
      var pointsCountEl = document.getElementById('points-count');

      var latInput = document.getElementById('lat-input');
      var lonInput = document.getElementById('lon-input');
      var addByInputBtn = document.getElementById('add-by-input');
      var clearAllBtn = document.getElementById('clear-all-btn');

      var routesListEl = document.getElementById('routes-list');

      var saveModal = document.getElementById('save-modal');
      var modalPointsCount = document.getElementById('modal-points-count');
      var routeNameInput = document.getElementById('route-name-input');
      var routeDescInput = document.getElementById('route-desc-input');
      var modalCancel = document.getElementById('modal-cancel');
      var modalSave = document.getElementById('modal-save');
      var modalTitle = document.getElementById('modal-title');

      var editingIndicator = document.getElementById('editing-indicator');
      var cancelEditBtn = document.getElementById('cancel-edit-btn');

      var routeDescriptionContainer = document.getElementById('route-description-container');
      var routeDescriptionEl = document.getElementById('route-description');
      var hideRouteDescBtn = document.getElementById('hide-route-desc');

      function getCookie(name) {
        var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
      }
      var csrftoken = getCookie('csrftoken');

      var points = [];
      var routes = loadRoutesFromStorage();

      var currentEditingRouteId = null;

      var polyline = new ymaps.GeoObject({
        geometry: { type: "LineString", coordinates: [] }
      }, {
        strokeColor: "#0077cc",
        strokeWidth: 4,
        strokeOpacity: 0.8
      });
      myMap.geoObjects.add(polyline);

      myMap.events.add('mousemove', function (e) {
        try {
          var c = e.get('coords');
          if (c && Array.isArray(c)) {
            coordsDisplay.textContent = Number(c[0]).toFixed(6) + ', ' + Number(c[1]).toFixed(6);
          }
        } catch (err) { console.warn('mousemove handler error', err); }
      });
      try {
        var containerEl = myMap.container.getElement();
        if (containerEl) {
          containerEl.addEventListener('mouseout', function() {
            coordsDisplay.textContent = 'Курсор вне карты';
          }, { passive: true });
        }
      } catch (e) {}

      function createPointOnServer(lat, lon) {
        return fetch('/map/points/create/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ lat: lat, lon: lon })
        }).then(function(resp){
          if (!resp.ok) {
            return resp.text().then(function(txt){
              throw new Error('Failed to create point on server: ' + resp.status + ' ' + txt);
            });
          }
          return resp.text();
        }).then(function(pkText){
           return pkText.trim();
        });
      }

      function fmt(coords) { return Number(coords[0]).toFixed(6) + ', ' + Number(coords[1]).toFixed(6); }
      function genId(prefix) { return (prefix||'id') + '-' + Date.now() + '-' + Math.floor(Math.random()*10000); }
      function updatePointsCount() { pointsCountEl.textContent = points.length + ' точек'; }

      function updatePolyline() {
        var coords = points.map(p => p.coords);
        polyline.geometry.setCoordinates(coords);
      }

      function clearPoints() {
        points.forEach(p => { if (p.placemark) myMap.geoObjects.remove(p.placemark); });
        points.length = 0;
        updatePolyline();
        renderList();
        updatePointsCount();
        exitEditMode();
        hideRouteDescription();
      }

      function parseInputs() {
        var lat = latInput.value.trim();
        var lon = lonInput.value.trim();
        if (lat === '' || lon === '') return null;
        var la = Number(lat.replace(',', '.'));
        var lo = Number(lon.replace(',', '.'));
        if (!isFinite(la) || !isFinite(lo)) return null;
        if (la < -90 || la > 90 || lo < -180 || lo > 180) return null;
        return [la, lo];
      }

      function addPoint(coords, addToList = true, providedId = null, image_url = null){
        var lat = Number(coords[0]), lon = Number(coords[1]);
        if (!isFinite(lat) || !isFinite(lon)) return;

        var serverId = null;
        if (providedId !== null) {
          if (/^\d+$/.test(String(providedId))) serverId = String(providedId);
          else serverId = null;
        }

        var id = genId('pt');

        var placemark = new ymaps.Placemark([lat, lon], { id: id }, {
          preset: 'islands#icon',
          iconColor: '#ff5722',
          balloonMaxWidth: 320
        });

        placemark.events.add('mouseenter', function(){ placemark.balloon.open(); });
        placemark.events.add('mouseleave', function(){ placemark.balloon.close(); });

        myMap.geoObjects.add(placemark);

        var item = {
          id: String(id),
          serverId: serverId,
          coords: [lat, lon],
          placemark: placemark,
          image_url: image_url || null
        };

        if (item.image_url) {
          var html = '<div style="max-width:260px"><img src="' + item.image_url + '" style="width:100%;height:auto;display:block;margin-bottom:6px;border-radius:6px"/></div>';
          html += '<div>Координаты: ' + fmt(item.coords) + '</div>';
          item.placemark.properties.set('balloonContent', html);
        }

        points.push(item);
        updatePolyline();
        if (addToList) renderList();
        updatePointsCount();
      }

      function enterEditMode(routeId) {
        currentEditingRouteId = routeId;
        editingIndicator.style.display = 'inline-block';
        cancelEditBtn.style.display = 'inline-block';
        modalTitle.textContent = 'Перезаписать маршрут';
        modalSave.textContent = 'Перезаписать';
      }

      function exitEditMode() {
        currentEditingRouteId = null;
        editingIndicator.style.display = 'none';
        cancelEditBtn.style.display = 'none';
        modalTitle.textContent = 'Сохранить маршрут';
        modalSave.textContent = 'Сохранить';
      }

      async function ensureServerId(point) {
        if (point.serverId) return point.serverId;

        var lat = point.coords[0], lon = point.coords[1];
        var pk = await createPointOnServer(lat, lon);
        point.serverId = String(pk);

        var li = coordList.querySelector('li[data-point-id="' + point.id + '"]');
        if (li) li.dataset.pointServerId = point.serverId;

        return point.serverId;
      }

      async function uploadFileToPoint(pk, file) {
        var url = '/points/' + pk + '/upload/';
        var form = new FormData();
        form.append('file', file);

        var resp = await fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          body: form
        });

        if (!resp.ok) {
          var t = await resp.text().catch(()=> '');
          throw new Error('Upload failed: ' + resp.status + ' ' + t);
        }

        var text = await resp.text();
        try {
          var j = JSON.parse(text);
          if (j && j.image_url) return j.image_url;
        } catch (e) {}
        return text.trim();
      }

      function showRouteDescription(text) {
        if (!text) return hideRouteDescription();
        routeDescriptionEl.textContent = text;
        routeDescriptionEl.classList.add('collapsed'); // start collapsed
        routeDescriptionContainer.style.display = 'block';
        hideRouteDescBtn.textContent = 'Показать полностью';
      }
      function hideRouteDescription() {
        routeDescriptionContainer.style.display = 'none';
        routeDescriptionEl.textContent = '';
      }
      function toggleRouteDescriptionExpand() {
        routeDescriptionEl.classList.toggle('collapsed');
        if (routeDescriptionEl.classList.contains('collapsed')) {
          hideRouteDescBtn.textContent = 'Показать полностью';
        } else {
          hideRouteDescBtn.textContent = 'Свернуть';
        }
      }
      hideRouteDescBtn.addEventListener('click', function(){ toggleRouteDescriptionExpand(); });

      function renderList() {
        coordList.innerHTML = '';
        if (points.length === 0) {
          var el = document.createElement('div');
          el.className = 'muted';
          el.textContent = 'Ничего не зафиксировано';
          coordList.appendChild(el);
          return;
        }
        points.forEach(function(item, idx) {
          var li = document.createElement('li');
          li.className = 'coord-item';
          li.dataset.pointId = item.id;
          if (item.serverId) li.dataset.pointServerId = item.serverId;

          var left = document.createElement('div');
          left.style.display = 'flex';
          left.style.flexDirection = 'column';

          var text = document.createElement('div');
          text.className = 'coord-text';
          text.textContent = (idx+1) + '. ' + fmt(item.coords);
          left.appendChild(text);

          var meta = document.createElement('div');
          meta.className = 'meta';
          meta.textContent = 'id: ' + item.id + (item.serverId ? (' | pk: ' + item.serverId) : '');
          left.appendChild(meta);

          if (item.image_url) {
            var img = document.createElement('img');
            img.className = 'point-thumb';
            img.src = item.image_url;
            left.appendChild(img);
          }

          var actions = document.createElement('div');
          actions.className = 'actions';

          var showBtn = document.createElement('button');
          showBtn.className = 'small-btn';
          showBtn.textContent = 'Показать';
          showBtn.addEventListener('click', function() {
            myMap.setCenter(item.coords, 14, { duration: 300 });
            if (item.placemark) item.placemark.balloon.open();
          });

          var uploadBtn = document.createElement('button');
          uploadBtn.className = 'small-btn btn-add-image';
          uploadBtn.textContent = 'Добавить изображение';

          var fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.style.display = 'none';
          fileInput.className = 'hidden-file-input';

          var upBtn = document.createElement('button');
          upBtn.className = 'small-btn';
          upBtn.textContent = '↑';
          upBtn.title = 'Переместить вверх';
          upBtn.addEventListener('click', function() {
            var i = points.findIndex(p => p.id === item.id);
            if (i > 0) {
              var tmp = points[i-1];
              points[i-1] = points[i];
              points[i] = tmp;
              updatePolyline(); renderList();
            }
          });

          var downBtn = document.createElement('button');
          downBtn.className = 'small-btn';
          downBtn.textContent = '↓';
          downBtn.title = 'Переместить вниз';
          downBtn.addEventListener('click', function() {
            var i = points.findIndex(p => p.id === item.id);
            if (i !== -1 && i < points.length - 1) {
              var tmp = points[i+1];
              points[i+1] = points[i];
              points[i] = tmp;
              updatePolyline(); renderList();
            }
          });

          var delBtn = document.createElement('button');
          delBtn.className = 'small-btn danger';
          delBtn.textContent = 'Удалить';
          delBtn.addEventListener('click', function() {
            if (item.placemark) myMap.geoObjects.remove(item.placemark);
            var i = points.findIndex(p => p.id === item.id);
            if (i !== -1) points.splice(i,1);
            updatePolyline();
            renderList();
            updatePointsCount();
          });

          actions.appendChild(showBtn);
          actions.appendChild(uploadBtn);
          actions.appendChild(fileInput);
          actions.appendChild(upBtn);
          actions.appendChild(downBtn);
          actions.appendChild(delBtn);

          li.appendChild(left);
          li.appendChild(actions);
          coordList.appendChild(li);
        });
      }

      function renderRoutesList() {
        routesListEl.innerHTML = '';
        if (!routes || routes.length === 0) {
          var el = document.createElement('div');
          el.className = 'muted';
          el.textContent = 'Нет сохранённых маршрутов';
          routesListEl.appendChild(el);
          return;
        }
        routes.forEach(function(route) {
          var li = document.createElement('li');
          li.className = 'route-item';

          var left = document.createElement('div');
          left.className = 'route-left';

          var nameRow = document.createElement('div');
          nameRow.className = 'route-name-row';

          var nameText = document.createElement('div');
          nameText.className = 'route-name';
          nameText.textContent = route.name || '(Без названия)';

          nameRow.appendChild(nameText);

          var toggleBtn = document.createElement('button');
          toggleBtn.className = 'route-toggle';
          toggleBtn.setAttribute('aria-expanded', 'false');
          var arrow = document.createElement('span');
          arrow.textContent = '▾'; // по умолчанию вниз
          arrow.style.transition = 'transform 180ms';
          toggleBtn.appendChild(arrow);

          nameRow.appendChild(toggleBtn);
          left.appendChild(nameRow);

          var descDiv = document.createElement('div');
          descDiv.className = 'route-item-desc';
          descDiv.textContent = route.description || '';
          left.appendChild(descDiv);

          var meta = document.createElement('div');
          meta.className = 'meta';
          meta.textContent = route.coords.length + ' точек';
          left.appendChild(meta);

          var actions = document.createElement('div');
          actions.className = 'route-actions';

          var showBtn = document.createElement('button');
          showBtn.className = 'small-btn';
          showBtn.textContent = 'Показать';
          showBtn.addEventListener('click', function() {
            loadRouteOnMap(route.id);
          });

          var editBtn = document.createElement('button');
          editBtn.className = 'small-btn';
          editBtn.textContent = 'Редактировать';
          editBtn.addEventListener('click', function() {
            clearPoints();
            route.coords.forEach(function(c){ addPoint(c, false); });
            renderList();
            updatePointsCount();
            updatePolyline();
            if (route.coords.length > 0) {
              myMap.setCenter(route.coords[0], 12, { duration: 300 });
            }
            routeNameInput.value = route.name || '';
            routeDescInput.value = route.description || '';
            enterEditMode(route.id);
          });

          var renameBtn = document.createElement('button');
          renameBtn.className = 'small-btn';
          renameBtn.textContent = 'Переименовать';
          renameBtn.addEventListener('click', function() {
            var newName = prompt('Новое название маршрута', route.name || '');
            if (newName === null) return;
            route.name = newName.trim() || '(Без названия)';
            saveRoutesToStorage();
            renderRoutesList();
          });

          var delBtn = document.createElement('button');
          delBtn.className = 'small-btn danger';
          delBtn.textContent = 'Удалить';
          delBtn.addEventListener('click', function() {
            if (!confirm('Удалить маршрут "' + route.name + '"?')) return;
            var i = routes.findIndex(r => r.id === route.id);
            if (i !== -1) routes.splice(i,1);
            saveRoutesToStorage();
            renderRoutesList();
          });

          actions.appendChild(showBtn);
          actions.appendChild(editBtn);
          actions.appendChild(renameBtn);
          actions.appendChild(delBtn);

          toggleBtn.addEventListener('click', function(e){
            e.stopPropagation();
            var opened = descDiv.classList.toggle('open');
            toggleBtn.setAttribute('aria-expanded', opened ? 'true' : 'false');
            arrow.textContent = opened ? '▴' : '▾';

            if (opened) {
              setTimeout(function(){
                if (li.scrollIntoView) li.scrollIntoView({ block: 'nearest' });
              }, 260);
            }
          });

          nameText.addEventListener('click', function(e){
            toggleBtn.click();
          });

          li.appendChild(left);
          li.appendChild(actions);
          routesListEl.appendChild(li);
        });
      }

      function loadRouteOnMap(routeId) {
        var route = routes.find(r => r.id === routeId);
        if (!route) return;
        clearPoints();
        // show description if present
        if (route.description && route.description.trim() !== '') {
          showRouteDescription(route.description);
        } else {
          hideRouteDescription();
        }
        route.coords.forEach(function(c){ addPoint(c, false); });
        renderList();
        updatePointsCount();
        updatePolyline();
        if (route.coords.length > 0) {
          myMap.setCenter(route.coords[0], 12, { duration: 300 });
        }
      }

      function saveCurrentPointsAsRoute(name, description) {
        if (points.length === 0) { alert('Нет точек для сохранения'); return; }
        var route = {
          id: genId('route'),
          name: name || ('Маршрут ' + (new Date()).toLocaleString()),
          coords: points.map(p => p.coords),
          description: description || '',
          createdAt: Date.now()
        };
        routes.push(route);
        saveRoutesToStorage();
        renderRoutesList();
      }

      function exportRoutes() {
        var payload = JSON.stringify(routes.map(r => ({ id:r.id, name:r.name, coords:r.coords, description: r.description || '', createdAt:r.createdAt })), null, 2);
        var blob = new Blob([payload], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url; a.download = 'routes.json'; document.body.appendChild(a); a.click();
        setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 500);
      }

      function importRoutesFromText(txt) {
        try {
          var parsed = JSON.parse(txt);
          if (!Array.isArray(parsed)) { alert('Формат ожидается как массив маршрутов'); return; }
          parsed.forEach(function(r){
            if (!r.id) r.id = genId('route');
            if (!r.name) r.name = 'Маршрут импортированный';
            if (!Array.isArray(r.coords)) r.coords = [];
            routes.push({ id:r.id, name:r.name, coords:r.coords, description: r.description || '', createdAt:r.createdAt || Date.now() });
          });
          saveRoutesToStorage();
          renderRoutesList();
        } catch (e) {
          alert('Ошибка парсинга JSON: ' + e.message);
        }
      }

      coordList.addEventListener('click', async function(e) {
        var btn = e.target.closest('.btn-add-image');
        if (btn) {
          var li = btn.closest('li.coord-item');
          if (!li) return;
          var input = li.querySelector('.hidden-file-input');
          if (input) input.click();
          return;
        }
      });

      coordList.addEventListener('change', async function(e) {
        var input = e.target;
        if (!input.matches('.hidden-file-input')) return;
        var file = input.files[0];
        if (!file) { input.value = ''; return; }
        if (file.size > 5 * 1024 * 1024) { alert('Файл слишком большой (макс 5MB)'); input.value = ''; return; }

        var li = input.closest('li.coord-item');
        if (!li) { input.value = ''; return; }
        var pointId = li.dataset.pointId;
        var point = points.find(p => p.id === pointId);
        if (!point) { input.value = ''; return; }

        var uploadBtn = li.querySelector('.btn-add-image');
        var origText = uploadBtn ? uploadBtn.textContent : null;
        if (uploadBtn) { uploadBtn.disabled = true; uploadBtn.textContent = 'Загрузка...'; }

        try {
          var pk = await ensureServerId(point);

          var imageUrl = await uploadFileToPoint(pk, file);

          if (!imageUrl) throw new Error('Server returned empty image URL');

          point.image_url = imageUrl;

          var img = li.querySelector('img.point-thumb');
          if (!img) {
            img = document.createElement('img');
            img.className = 'point-thumb';
            li.querySelector('div').appendChild(img);
          }
          img.src = imageUrl;

          if (point.placemark) {
            var html = '<div style="max-width:260px"><img src="' + imageUrl + '" style="width:100%;height:auto;display:block;margin-bottom:6px;border-radius:6px"/></div>';
            html += '<div>Координаты: ' + fmt(point.coords) + '</div>';
            point.placemark.properties.set('balloonContent', html);
          }

          input.value = '';
        } catch (err) {
          console.error(err);
          alert('Ошибка загрузки: ' + (err.message || err));
          input.value = '';
        } finally {
          if (uploadBtn) { uploadBtn.disabled = false; uploadBtn.textContent = origText; }
        }
      });

      addByInputBtn.addEventListener('click', async function() {
        var coords = parseInputs();
        if (!coords) { alert('Введите корректные числа для широты и долготы.'); return; }
        try {
          addPoint(coords, true, null, null);
          var newPoint = points[points.length - 1];
          try {
            var pk = await createPointOnServer(newPoint.coords[0], newPoint.coords[1]);
            newPoint.serverId = String(pk);
            renderList();
          } catch (e) {
            console.warn('Не удалось создать точку на сервере:', e);
          }
        } catch (err) {
          console.error(err);
          alert('Ошибка при создании точки: ' + (err.message || err));
        }
      });

      myMap.events.add('click', function(e){
        var c = e.get('coords');
        if (c && Array.isArray(c)) {
          addPoint(c, true);
        }
      });

      clearAllBtn.addEventListener('click', clearPoints);
      clearBtn.addEventListener('click', clearPoints);

      saveRouteBtn.addEventListener('click', function() {
        if (points.length === 0) { alert('Нет точек для сохранения'); return; }
        modalPointsCount.textContent = points.length;
        if (currentEditingRouteId) {
          var route = routes.find(r => r.id === currentEditingRouteId);
          routeNameInput.value = route ? (route.name || '') : ('Маршрут ' + (new Date()).toLocaleString());
          routeDescInput.value = route ? (route.description || '') : '';
        } else {
          routeNameInput.value = 'Маршрут ' + (new Date()).toLocaleString();
          routeDescInput.value = '';
        }
        saveModal.style.display = 'flex';
        routeNameInput.focus();
      });

      modalCancel.addEventListener('click', function(){ saveModal.style.display = 'none'; });

      modalSave.addEventListener('click', function() {
        var name = routeNameInput.value.trim() || ('Маршрут ' + (new Date()).toLocaleString());
        var desc = routeDescInput.value || '';
        if (currentEditingRouteId) {
          var route = routes.find(r => r.id === currentEditingRouteId);
          if (!route) {
            alert('Не удалось найти редактируемый маршрут');
            saveModal.style.display = 'none';
            exitEditMode();
            return;
          }
          route.name = name;
          route.description = desc;
          route.coords = points.map(p => p.coords);
          route.createdAt = Date.now();
          saveRoutesToStorage();
          renderRoutesList();
          saveModal.style.display = 'none';
          exitEditMode();
          alert('Маршрут обновлён');
        } else {
          // создать новый маршрут с описанием
          saveCurrentPointsAsRoute(name, desc);
          saveModal.style.display = 'none';
        }
      });

      cancelEditBtn.addEventListener('click', function(){
        if (!confirm('Отменить редактирование и сбросить текущие изменения?')) return;
        clearPoints();
        exitEditMode();
      });

      function saveRoutesToStorage() {
        try {
          var plain = routes.map(r => ({ id:r.id, name:r.name, coords:r.coords, description: r.description || '', createdAt:r.createdAt }));
          localStorage.setItem('saved_routes_v1', JSON.stringify(plain));
        } catch (e) { console.warn('Не удалось сохранить маршруты', e); }
      }

      function loadRoutesFromStorage() {
        try {
          var raw = localStorage.getItem('saved_routes_v1');
          if (!raw) return [];
          var parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed.map(r => ({ id:r.id, name:r.name, coords:r.coords || [], description: r.description || '', createdAt:r.createdAt || Date.now() }));
        } catch (e) { console.warn('Не удалось загрузить маршруты', e); return []; }
      }

      renderList();
      renderRoutesList();
      updatePointsCount();
  }
  </script>
</body>
</html>
